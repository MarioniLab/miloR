---
title: "Estimating equations for a NB-GLMM"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

This notebook will keep a record of the various equations, functions and derivatives required to build a functioning negative binomial GLMM.

## Calculating first and second derivatives for score and hessian

We have $V(\sigma)* = ZGZ^{T} + D^{-1}VD^{-1}$, where $D^{-1} = diag(\frac1\mu)$ and $V={diag}(\frac{\mu^{2}}{r} - \mu)$

Applying the product rule, we get:

$$ \frac{\partial ZGZ^{T}}{\partial\sigma^{2}} = ZZ^{T} \\ 
\frac{\partial D^{-1}VD^{-1}}{\partial\sigma^{2}} = \frac{\partial D^{-1}}{\partial\sigma^{2}}VD^{-1} + D^{-1}\frac{\partial V}{\partial\sigma^{2}}D^{-1} + D^{-1}V\frac{\partial D^{-1}}{\partial\sigma^{2}}$$

To compute$\frac{\partial D^{-1}}{\partial\sigma^{2}}$ and $\frac{\partial V}{\partial\sigma^{2}}$, we can use the chain rule:

$$\frac{\partial D^{-1}}{\partial\sigma^{2}} = \frac{\partial D^{-1}}{\partial\mu} \frac{\partial \mu}{\partial\eta} \frac{\partial \eta}{\partial b} \frac{\partial b}{\partial \sigma^{2}} \\
\frac{\partial V}{\partial\sigma^{2}} = \frac{\partial V}{\partial\mu} \frac{\partial \mu}{\partial\eta} \frac{\partial \eta}{\partial b} \frac{\partial b}{\partial \sigma^{2}}$$

where we know the following:

$$D^{-1} = diag(\frac1\mu)\\
\frac{\partial D^{-1}}{\partial\mu} = diag(\frac{-1}{\mu^{2}})\\
V = {diag}(\frac{\mu^{2}}{r} - \mu)\\
\frac{\partial V}{\partial\mu} = {diag}(\frac{2\mu}{r} - 1) \\
\mu = e^{\eta}\\
\frac{\partial \mu}{\partial\eta} = e^{\eta} = diag(\mu) = D\\
\eta = X\beta + Zb\\
\frac{\partial \eta}{\partial b} = Z\\
\sigma^{2} = \frac{1}{q-1} \sum b^{2} \\
\frac{\partial \sigma^{2}}{\partial b} = \frac{1}{q-1} \sum 2b\\
\frac{\partial b}{\partial \sigma^{2}} = [\frac{1}{q-1} \sum 2b]^{-1}$$

Therefore:
 
$$\frac{\partial D^{-1}}{\partial\sigma^{2}} = \frac{\partial D^{-1}}{\partial\mu} \frac{\partial \mu}{\partial\eta} \frac{\partial \eta}{\partial b} \frac{\partial b}{\partial \sigma^{2}} \\
\frac{\partial D^{-1}}{\partial\sigma^{2}} = diag(\frac{-1}{\mu^{2}}) DZ [\frac{1}{q-1} \sum 2b]^{-1} \\
\frac{\partial V}{\partial\sigma^{2}} = \frac{\partial V}{\partial\mu} \frac{\partial \mu}{\partial\eta} \frac{\partial \eta}{\partial b} \frac{\partial b}{\partial \sigma^{2}} \\
\frac{\partial V}{\partial\sigma^{2}} = {diag}(\frac{2\mu}{r} - 1) DZ [\frac{1}{q-1} \sum 2b]^{-1}$$


Putting this all together, we get the following for the first order partial derivatives:

$$\frac{ \partial V(\sigma)*}{\partial \sigma^{2}} = \frac{\partial (ZGZ^{T} + D^{-1}VD^{-1})}{\partial\sigma^{2}} \\
= ZZ^{T} + \frac{\partial D^{-1}}{\partial\sigma^{2}}VD^{-1} + D^{-1}\frac{\partial V}{\partial\sigma^{2}}D^{-1} + D^{-1}V\frac{\partial D^{-1}}{\partial\sigma^{2}} \\
= ZZ^{T} + diag(\frac{-1}{\mu^{2}}) DZ [\frac{1}{q-1} \sum 2b]^{-1}VD^{-1} + D^{-1}{diag}(\frac{2\mu}{r} - 1) DZ [\frac{1}{q-1} \sum 2b]^{-1}D^{-1} + D^{-1}Vdiag(\frac{-1}{\mu^{2}}) DZ [\frac{1}{q-1} \sum 2b]^{-1} $$

For the second partial derivative, we need to once more apply the product rule.

$$\frac{ \partial ZGZ^{T} + D^{-1}VD^{-1}}{\partial\sigma^{2}} = ZZ^{T} + \frac{\partial D^{-1}}{\partial\sigma^{2}}VD^{-1} + D^{-1}\frac{\partial V}{\partial\sigma^{2}}D^{-1} + D^{-1}V\frac{\partial D^{-1}}{\partial\sigma^{2}} \\

\frac{\partial^{2} ZGZ^{T} + D^{-1}VD^{-1}}{\partial\sigma^{2}} = (\frac{\partial^{2}D^{-1}}{\partial\sigma^{2}}VD^{-1} + \frac{\partial D^{-1}}{\partial\sigma^{2}} \frac{\partial V}{\partial\sigma^{2}}D^{-1} + \frac{\partial D^{-1}}{\partial\sigma^{2}}V\frac{\partial D^{-1}}{\partial\sigma^{2}}) \\

+ (\frac{\partial D^{-1}}{\partial\sigma^{2}} \frac{\partial V}{\partial\sigma^{2}}D^{-1} + D^{-1}\frac{\partial ^{2} V}{\partial\sigma^{2}}D^{-1} + D^{-1}V\frac{\partial D^{-1}}{\partial\sigma^{2}}) \\

+ (\frac{\partial D^{-1}}{\partial\sigma^{2}}V\frac{\partial D^{-1}}{\partial\sigma^{2}} + D^{-1} \frac{\partial V}{\partial\sigma^{2}}\frac{\partial D^{-1}}{\partial\sigma^{2}} + D^{-1}V\frac{\partial ^{2} D^{-1}}{\partial\sigma^{2}})$$

That is,