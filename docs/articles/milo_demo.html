<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Differential abundance testing with Milo â€¢ miloR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Differential abundance testing with Milo">
<meta property="og:description" content="miloR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">miloR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/milo_demo.html">Differential abundance testing with Milo</a>
    </li>
    <li>
      <a href="../articles/milo_gastrulation.html">Differential abundance testing with Milo - Mouse gastrulation example</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="milo_demo_files/header-attrs-2.5/header-attrs.js"></script><script src="milo_demo_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="milo_demo_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="milo_demo_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Differential abundance testing with Milo</h1>
                        <h4 class="author">Emma Dann</h4>
                        <h4 class="author">Mike Morgan</h4>
            
      
      
      <div class="hidden name"><code>milo_demo.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">miloR</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">SingleCellExperiment</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">scater</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">patchwork</span>)</pre></body></html></div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Milo is a tool for analysis of complex single cell datasets generated from replicated multi-condition experiments, which detects changes in composition between conditions. While differential abundance (DA) is commonly quantified in discrete cell clusters, Milo uses partally overlapping neighbourhoods of cells on a KNN graph. Starting from a graph that faithfully recapitulates the biology of the cell population, Milo analysis consists of 3 steps:</p>
<ol style="list-style-type: decimal">
<li>Sampling of representative neighbourhoods</li>
<li>Testing for differential abundance of conditions in all neighbourhoods</li>
<li>Accounting for multiple hypothesis testing using a weighted FDR procedure that accounts for the overlap of neighbourhoods</li>
</ol>
<p>In this vignette we will elaborate on how these steps are implemented in the <code>miloR</code> package.</p>
</div>
<div id="load-data" class="section level1">
<h1 class="hasAnchor">
<a href="#load-data" class="anchor"></a>Load data</h1>
<p>For this demo we will use a synthetic dataset simulating a developmental trajectory, generated using <a href="https://github.com/dynverse/dyntoy">dyntoy</a>.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"sim_trajectory"</span>, <span class="kw">package</span> <span class="kw">=</span> <span class="st">"miloR"</span>)

<span class="co">## Extract SingleCellExperiment object</span>
<span class="no">traj_sce</span> <span class="kw">&lt;-</span> <span class="no">sim_trajectory</span><span class="kw">[[</span><span class="st">'SCE'</span>]]

<span class="co">## Extract sample metadata to use for testing</span>
<span class="no">traj_meta</span> <span class="kw">&lt;-</span> <span class="no">sim_trajectory</span><span class="kw">[[</span><span class="st">"meta"</span>]]

<span class="co">## Add metadata to colData slot</span>
<span class="fu">colData</span>(<span class="no">traj_sce</span>) <span class="kw">&lt;-</span> <span class="fu">DataFrame</span>(<span class="no">traj_meta</span>)</pre></body></html></div>
</div>
<div id="pre-processing" class="section level1">
<h1 class="hasAnchor">
<a href="#pre-processing" class="anchor"></a>Pre-processing</h1>
<p>For DA analysis we need to construct an undirected KNN graph of single-cells. Standard single-cell analysis pipelines usually do this from distances in PCA. We normalize and calculate principal components using <code>scater</code>. I also run UMAP for visualization purposes.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">logcounts</a></span>(<span class="no">traj_sce</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">counts</a></span>(<span class="no">traj_sce</span>) + <span class="fl">1</span>)
<span class="no">traj_sce</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/runPCA.html">runPCA</a></span>(<span class="no">traj_sce</span>, <span class="kw">ncomponents</span><span class="kw">=</span><span class="fl">30</span>)
<span class="no">traj_sce</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/runUMAP.html">runUMAP</a></span>(<span class="no">traj_sce</span>)

<span class="fu"><a href="https://rdrr.io/pkg/scater/man/plot_reddim.html">plotUMAP</a></span>(<span class="no">traj_sce</span>)</pre></body></html></div>
<p><img src="milo_demo_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
<div id="create-a-milo-object" class="section level1">
<h1 class="hasAnchor">
<a href="#create-a-milo-object" class="anchor"></a>Create a Milo object</h1>
<p>For differential abundance analysis on graph neighbourhoods we first construct a <code>Milo</code> object. This extends the <a href="https://bioconductor.org/packages/release/bioc/html/SingleCellExperiment.html"><code>SingleCellExperiment</code></a> class to store information about neighbourhoods on the KNN graph.</p>
<div id="from-singlecellexperiment-object" class="section level2">
<h2 class="hasAnchor">
<a href="#from-singlecellexperiment-object" class="anchor"></a>From SingleCellExperiment object</h2>
<p>The <code>Milo</code> constructor takes as input a <code>SingleCellExperiment</code> object.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">traj_milo</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/Milo.html">Milo</a></span>(<span class="no">traj_sce</span>)
<span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html">reducedDim</a></span>(<span class="no">traj_milo</span>, <span class="st">"UMAP"</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html">reducedDim</a></span>(<span class="no">traj_sce</span>, <span class="st">"UMAP"</span>)

<span class="no">traj_milo</span></pre></body></html></div>
<pre><code>## class: Milo 
## dim: 500 500 
## metadata(0):
## assays(2): counts logcounts
## rownames(500): G1 G2 ... G499 G500
## rowData names(0):
## colnames: NULL
## colData names(5): cell_id group_id Condition Replicate Sample
## reducedDimNames(2): PCA UMAP
## spikeNames(0):
## altExpNames(0):
## nhoods dimensions(1): 0
## nhoodCounts dimensions(2): 1 1
## nhoodDistances dimension(1): 0
## graph names(0):
## nhoodIndex names(1): 0
## nhoodExpression dimension(2): 1 1
## nhoodReducedDim names(0):
## nhoodGraph names(0):
## nhoodAdjacency dimension(0):</code></pre>
</div>
<div id="from-anndata-object--h5ad" class="section level2">
<h2 class="hasAnchor">
<a href="#from-anndata-object--h5ad" class="anchor"></a>From AnnData object (.h5ad)</h2>
<p>We can use the <a href="https://theislab.github.io/zellkonverter/articles/zellkonverter.html"><code>zellkonverter</code></a> package to make a <code>SingleCellExperiment</code> object from an <code>AnnData</code> object stored as <code>h5ad</code> file.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">zellkonverter</span>)

<span class="co"># Obtaining an example H5AD file.</span>
<span class="no">example_h5ad</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"krumsiek11.h5ad"</span>,
                            <span class="kw">package</span> <span class="kw">=</span> <span class="st">"zellkonverter"</span>)

<span class="no">example_h5ad_sce</span> <span class="kw">&lt;-</span> <span class="fu">readH5AD</span>(<span class="no">example_h5ad</span>)
<span class="no">example_h5ad_milo</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/Milo.html">Milo</a></span>(<span class="no">example_h5ad_sce</span>)</pre></body></html></div>
</div>
<div id="from-seurat-object" class="section level2">
<h2 class="hasAnchor">
<a href="#from-seurat-object" class="anchor"></a>From Seurat object</h2>
<p>The <code>Seurat</code> package includes a converter to <code>SingleCellExperiment</code>.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">Seurat</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"pbmc_small"</span>)
<span class="no">pbmc_small_sce</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Seurat/man/as.SingleCellExperiment.html">as.SingleCellExperiment</a></span>(<span class="no">pbmc_small</span>)
<span class="no">pbmc_small_milo</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/Milo.html">Milo</a></span>(<span class="no">pbmc_small_sce</span>)</pre></body></html></div>
</div>
</div>
<div id="construct-knn-graph" class="section level1">
<h1 class="hasAnchor">
<a href="#construct-knn-graph" class="anchor"></a>Construct KNN graph</h1>
<p>We need to add the KNN graph to the Milo object. This is stored in the <code>graph</code> slot, in <a href="https://igraph.org/r/"><code>igraph</code></a> format. The <code>miloR</code> package includes functionality to build and store the graph from the PCA dimensions stored in the <code>reducedDim</code> slot.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">traj_milo</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/buildGraph.html">buildGraph</a></span>(<span class="no">traj_milo</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">10</span>, <span class="kw">d</span> <span class="kw">=</span> <span class="fl">30</span>)</pre></body></html></div>
<pre><code>## Constructing kNN graph with k:10</code></pre>
<p><strong>In progress:</strong> we are perfecting the functionality to add a precomputed KNN graph (for example constructed with Seurat or scanpy) to the <code>graph</code> slot using the adjacency matrix.</p>
<!-- Alternatively, if you already have a KNN graph (for example constructed with Seurat/scanpy) you can add it from the adjacency matrix. -->
<!-- ```{r} -->
<!-- # ## Build up a mock SNN graph made with Seurat -->
<!-- # pca_df <- reducedDim(traj_milo, "PCA") -->
<!-- # rownames(pca_df) <- traj_milo$cell_id -->
<!-- # snn_graph <- FindNeighbors(pca_df)[["snn"]] -->
<!-- #  -->
<!-- # graph(traj_milo) <-  graph(buildFromAdjacency(snn_graph, k=10)) -->
<!-- ``` -->
</div>
<div id="defining-representative-neighbourhoods" class="section level1">
<h1 class="hasAnchor">
<a href="#defining-representative-neighbourhoods" class="anchor"></a>1. Defining representative neighbourhoods</h1>
<p>We define the neighbourhood of a cell, the index, as the group of cells connected by an edge in the KNN graph to the index cell. For efficiency, we donâ€™t test for DA in the neighbourhood of every cell, but we sample as indices a subset of representative cells, using a KNN sampling algorithm used by <a href="https://www.nature.com/articles/nmeth.3545">Gut et al.Â 2015</a>.</p>
<p>For sampling you need to define a few parameters:</p>
<ul>
<li>
<code>prop</code>: the proportion of cells to randomly sample to start with (usually 0.1 - 0.2 is sufficient)</li>
<li>
<code>k</code>: the k to use for KNN refinement (we recommend using the same k used for KNN graph building)</li>
<li>
<code>d</code>: the number of reduced dimensions to use for KNN refinement (we recommend using the same d used for KNN graph building)</li>
<li>
<code>refined</code> indicated whether you want to use the sampling refinement algorith, or just pick cells at random. The default and recommended way to go is to use refinement. The only situation in which you might consider using random instead, is if you have batch corrected your data with a graph based correction algorithm, such as <a href="https://github.com/Teichlab/bbknn">BBKNN</a>, but the results of DA testing will be suboptimal.</li>
</ul>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">traj_milo</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/makeNhoods.html">makeNhoods</a></span>(<span class="no">traj_milo</span>, <span class="kw">prop</span> <span class="kw">=</span> <span class="fl">0.1</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">10</span>, <span class="kw">d</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">refined</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<pre><code>## Checking valid object</code></pre>
<pre><code>## Warning in .refined_sampling(random_vertices, X_reduced_dims, k): Rownames not
## set on reducedDims - setting to row indices</code></pre>
<p>Once we have defined neighbourhoods, itâ€™s good to take a look at how big the neighbourhoods are (i.e.Â how many cells form each neighbourhood). This affects the power of DA testing. We can check this out using the <code>plotNhoodSizeHist</code> function. Empirically, we found itâ€™s best to have a distribution peaking between 50 and 100. Otherwise you might consider rerunning <code>makeNhoods</code> increasing <code>k</code> and/or <code>prop</code> (here the distribution looks ludicrous because itâ€™s a small dataset).</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="../reference/plotNhoodSizeHist.html">plotNhoodSizeHist</a></span>(<span class="no">traj_milo</span>)</pre></body></html></div>
<p><img src="milo_demo_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
<div id="counting-cells-in-neighbourhoods" class="section level1">
<h1 class="hasAnchor">
<a href="#counting-cells-in-neighbourhoods" class="anchor"></a>Counting cells in neighbourhoods</h1>
<p>Now we have to count how many cells from each sample are in each neighbourhood. We need to use the cell metadata and specify which column contains the sample information.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">traj_milo</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/countCells.html">countCells</a></span>(<span class="no">traj_milo</span>, <span class="kw">meta.data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu">colData</span>(<span class="no">traj_milo</span>)), <span class="kw">sample</span><span class="kw">=</span><span class="st">"Sample"</span>)</pre></body></html></div>
<pre><code>## Checking meta.data validity</code></pre>
<pre><code>## Setting up matrix with 36 neighbourhoods</code></pre>
<pre><code>## Counting cells in neighbourhoods</code></pre>
<p>This adds to the <code>Milo</code> object a <code>n \times m</code> matrix, where n is the number of neighbourhoods and <span class="math inline">\(m\)</span> is the number of experimental samples. Values indicate the number of cells from each sample counted in a neighbourhood. This count matrix will be used for DA testing.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fu"><a href="../reference/methods.html">nhoodCounts</a></span>(<span class="no">traj_milo</span>))</pre></body></html></div>
<pre><code>## 6 x 6 sparse Matrix of class "dgCMatrix"
##   B_R1 A_R1 A_R2 B_R2 B_R3 A_R3
## 1   11    2    5   13   17    2
## 2   12    1    .   11   10    2
## 3    3    .    1    9   13    .
## 4   15    .    1   22   29    1
## 5   13    5    3   14   16    1
## 6    9    6    7    7    6   10</code></pre>
</div>
<div id="differential-abundance-testing" class="section level1">
<h1 class="hasAnchor">
<a href="#differential-abundance-testing" class="anchor"></a>Differential abundance testing</h1>
<p>Now we are all set to test for differential abundance in neighbourhoods. We implement this hypothesis testing in a generalized linear model (GLM) framework, specifically using the Negative Binomial GLM implementation in <a href="https://bioconductor.org/packages/release/bioc/html/edgeR.html"><code>edgeR</code></a>.</p>
<p>We first need to think about our experimental design. The design matrix should match samples to a condition of interest. In this case the <code>Condition</code> is the covariate we are going to test for.</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">traj_design</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu">colData</span>(<span class="no">traj_milo</span>))[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Sample"</span>, <span class="st">"Condition"</span>)]
<span class="no">traj_design</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>(<span class="no">traj_design</span>)

<span class="no">traj_design</span></pre></body></html></div>
<pre><code>##   Sample Condition
## 1   B_R1         B
## 2   A_R1         A
## 3   A_R2         A
## 4   B_R2         B
## 5   B_R3         B
## 6   A_R3         A</code></pre>
<p>Milo uses an adaptation of the Spatial FDR correction introduced by <a href="https://bioconductor.org/packages/release/bioc/html/cydar.html">cydar</a>, which accounts for the overlap between neighbourhoods. Specifically, each hypothesis test P-value is weighted by the reciprocal of the kth nearest neighbour distance. To use this statistic we first need to store the distances between nearest neighbors in the Milo object.</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">traj_milo</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/calcNhoodDistance.html">calcNhoodDistance</a></span>(<span class="no">traj_milo</span>, <span class="kw">d</span><span class="kw">=</span><span class="fl">30</span>)</pre></body></html></div>
<p>Now we can do the test, explicitly defining our experimental design.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">da_results</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/testNhoods.html">testNhoods</a></span>(<span class="no">traj_milo</span>, <span class="kw">design</span> <span class="kw">=</span> ~ <span class="no">Condition</span>, <span class="kw">design.df</span> <span class="kw">=</span> <span class="no">traj_design</span>)</pre></body></html></div>
<pre><code>## Performing spatial FDR correction withk-distance weightingPerforming spatial FDR correction withneighbour-distance weightingPerforming spatial FDR correction withedge weightingPerforming spatial FDR correction withvertex weightingPerforming spatial FDR correction withnone weighting</code></pre>
<p>This calculates a Fold-change and corrected P-value for each neighbourhood, which indicates wheather there is significant differential abundance between conditions.</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="no">da_results</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(- <span class="no">SpatialFDR</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()</pre></body></html></div>
<pre><code>##          logFC   logCPM           F    PValue       FDR Nhood SpatialFDR
## 31 -0.06825178 18.78491 0.003497229 0.9529247 0.9529247    31  0.9529247
## 9  -0.15157840 19.18524 0.043719291 0.8346722 0.8770780     9  0.8811436
## 12 -0.13116723 19.72564 0.094539515 0.7808573 0.8770780    12  0.8811436
## 20 -0.09947561 19.53278 0.034592108 0.8527147 0.8770780    20  0.8811436
## 22  0.11712737 19.46188 0.054221958 0.8266405 0.8770780    22  0.8811436
## 25 -0.11490917 20.07120 0.075454714 0.7839480 0.8770780    25  0.8811436</code></pre>
</div>
<div id="visualize-neighbourhoods-displaying-da" class="section level1">
<h1 class="hasAnchor">
<a href="#visualize-neighbourhoods-displaying-da" class="anchor"></a>Visualize neighbourhoods displaying DA</h1>
<p>To visualize DA results, we build an abstracted graph of neighbourhoods that we can superimpose on the single-cell embedding.</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="no">traj_milo</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/buildNhoodGraph.html">buildNhoodGraph</a></span>(<span class="no">traj_milo</span>)</pre></body></html></div>
<pre><code>## Calculating nhood adjacency</code></pre>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/scater/man/plot_reddim.html">plotUMAP</a></span>(<span class="no">traj_milo</span>) + <span class="fu"><a href="../reference/plotNhoodGraphDA.html">plotNhoodGraphDA</a></span>(<span class="no">traj_milo</span>, <span class="no">da_results</span>, <span class="kw">alpha</span><span class="kw">=</span><span class="fl">0.05</span>) +
  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span>(<span class="kw">guides</span><span class="kw">=</span><span class="st">"collect"</span>)</pre></body></html></div>
<p><img src="milo_demo_files/figure-html/unnamed-chunk-16-1.png" width="960"></p>
<details><p><summary><strong>Session Info</strong></summary></p>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span>()</pre></body></html></div>
<pre><code>## R version 3.6.3 (2020-02-29)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 18.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.7.1
## LAPACK: /usr/lib/x86_64-linux-gnu/openblas/liblapack.so.3
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] parallel  stats4    stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] patchwork_1.0.1             dplyr_1.0.2                
##  [3] scater_1.14.6               ggplot2_3.3.2              
##  [5] SingleCellExperiment_1.8.0  SummarizedExperiment_1.16.1
##  [7] DelayedArray_0.12.3         BiocParallel_1.20.1        
##  [9] matrixStats_0.56.0          Biobase_2.46.0             
## [11] GenomicRanges_1.38.0        GenomeInfoDb_1.22.1        
## [13] IRanges_2.20.2              S4Vectors_0.24.4           
## [15] BiocGenerics_0.32.0         miloR_0.1.0                
## [17] edgeR_3.28.1                limma_3.42.2               
## [19] BiocStyle_2.14.4           
## 
## loaded via a namespace (and not attached):
##  [1] bitops_1.0-6             fs_1.5.0                 rprojroot_1.3-2         
##  [4] tools_3.6.3              backports_1.1.9          R6_2.4.1                
##  [7] irlba_2.3.3              vipor_0.4.5              uwot_0.1.8              
## [10] colorspace_1.4-1         withr_2.2.0              tidyselect_1.1.0        
## [13] gridExtra_2.3            bit_4.0.4                compiler_3.6.3          
## [16] BiocNeighbors_1.4.2      desc_1.2.0               labeling_0.3            
## [19] bookdown_0.20            scales_1.1.1             pkgdown_1.5.1           
## [22] stringr_1.4.0            digest_0.6.25            rmarkdown_2.5           
## [25] XVector_0.26.0           pkgconfig_2.0.3          htmltools_0.5.0         
## [28] rlang_0.4.7              rstudioapi_0.11          FNN_1.1.3               
## [31] DelayedMatrixStats_1.8.0 farver_2.0.3             generics_0.0.2          
## [34] gtools_3.8.2             RCurl_1.98-1.2           magrittr_1.5            
## [37] BiocSingular_1.2.2       GenomeInfoDbData_1.2.2   Matrix_1.2-18           
## [40] Rcpp_1.0.5               ggbeeswarm_0.6.0         munsell_0.5.0           
## [43] viridis_0.5.1            lifecycle_0.2.0          stringi_1.4.6           
## [46] yaml_2.2.1               ggraph_2.0.3             MASS_7.3-51.5           
## [49] zlibbioc_1.32.0          grid_3.6.3               ggrepel_0.8.2           
## [52] crayon_1.3.4             lattice_0.20-40          splines_3.6.3           
## [55] cowplot_1.0.0            graphlayouts_0.7.0       locfit_1.5-9.4          
## [58] knitr_1.30               pillar_1.4.6             igraph_1.2.5            
## [61] glue_1.4.1               evaluate_0.14            BiocManager_1.30.10     
## [64] vctrs_0.3.2              tweenr_1.0.1             gtable_0.3.0            
## [67] purrr_0.3.4              polyclip_1.10-0          tidyr_1.1.1             
## [70] assertthat_0.2.1         xfun_0.19                ggforce_0.3.2           
## [73] rsvd_1.0.3               tidygraph_1.2.0          RSpectra_0.16-0         
## [76] viridisLite_0.3.0        tibble_3.0.3             beeswarm_0.2.3          
## [79] memoise_1.1.0            statmod_1.4.34           ellipsis_0.3.1</code></pre>
</details>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mike Morgan, Emma Dann.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
